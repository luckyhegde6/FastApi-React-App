name: Deploy to GitHub Pages

on:
  push:

    branches: [main]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20 # Or your preferred version

      - name: Install dependencies (frontend)
        run: cd React/finance-app && npm install

      - name: Install dependencies (backend)
        run: cd FastAPI && pip install -r requirements.txt

      - name: Install Playwright browsers
        run: cd React/finance-app && npx playwright install

      - name: Start backend
        run: |
          cd FastAPI
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 --reload &
          sleep 5  # Give the backend some time to start
        env:
          DATABASE_URL: sqlite:///./finance.db

      - name: Run end-to-end tests
        run: cd React/finance-app && npm run e2e
        env:
          CI: true
          API_BASE_URL: http://localhost:8000

  deploy:
    needs: e2e-tests  # Ensure e2e tests pass before deploying
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20 # Or your preferred version

      - name: Install dependencies (frontend)
        run: cd React/finance-app && npm install

      - name: Install dependencies (backend)
        run: cd FastAPI && pip install -r requirements.txt

      - name: Start backend (for deployment)
        run: |
          cd FastAPI
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 --reload &
          sleep 5  # Give the backend some time to start
        env:
          DATABASE_URL: sqlite:///./finance.db

      - name: Build React app
        run: cd React/finance-app && npm run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: React/finance-app/dist

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v2

permissions:
  pages: write      # to deploy to Pages
  id-token: write   # to verify the deployment originates from our repository

